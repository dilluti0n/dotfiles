#!/usr/bin/env bash

url="$(tee | xargs)"
self=vgreb

if [ -t 0 ] && [ $# -eq 0 ]; then
    echo "Usage: echo <url> | $self"
    exit 1
fi

msg() {
    notify-send "$self" "$1"
    echo "$self: $1"
}

if [ -z "$url" ]; then
    msg "Error: no url provided" >&2
    exit 1
fi

if [[ "$url" =~ [[:space:]] ]]; then
    msg "Error: $url: Invalid URL (whitespace detected)" >&2
    exit 1
fi

safe_url=$(echo -n "$url" | sed 's/[^a-zA-Z0-9]/_/g' | cut -c 1-100)

log_dir="/tmp/${self}_$(whoami)"
mkdir -p "$log_dir"
log_file="$log_dir/$safe_url.log"

msg "Download start: $url"
yt-dlp --color never --no-progress \
    --rm-cache-dir \
    "$url" > "$log_file" 2>&1
rc=$?

if [ $rc -eq 0 ]; then
    msg "Complete: $url"
else
    echo "Fail: $url (exit with $rc). See $log_file"
    echo "$url" $(date -Iseconds) "$log_file" >> "$log_dir/error_urls"
    action=$(notify-send "$self" "Fail: $rc. Click to see log" \
        --action="default=View Log")

    case "$action" in
        "default") foot -T "${self}-log" less "$log_file" ;;
    esac
fi

exit $rc
