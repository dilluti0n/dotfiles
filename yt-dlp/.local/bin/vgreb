#!/usr/bin/env bash

url="$(tee | xargs)"
self=vgreb

if [ -t 0 ] && [ $# -eq 0 ]; then
    echo "Usage: echo <url> | $self"
    exit 1
fi

msg() {
    notify-send "$self" "$1"
    echo "$self: $1"
}

if [ -z "$url" ]; then
    msg "Error: no url provided" >&2
    exit 1
fi

if [[ "$url" =~ [[:space:]] ]]; then
    msg "Error: $url: Invalid URL (whitespace detected)" >&2
    exit 1
fi

prefix="$HOME/.$self"
history="$prefix/history"
log_dir="$prefix/logs"

mkdir -p "$prefix"
mkdir -p "$log_dir"
SHA=sha1sum
url_hash="$(echo -n $url | $SHA | awk '{print $1}')"
log_file="$log_dir/${url_hash}.log"

log_format='%s\t%s\t%s\t%\t%ss\n'
[ ! -f "$history" ] && printf "$log_format" date state url file log_file > "$history"

history_line() {
    # $1: SUCCESS|FAIL
    # $2: actual downloaded file
    printf "$log_format" "$(date -Iseconds)" "$1" "$url" "$2" "$log_file"
}

msg "Download start: $url"
tmpfile=$(mktemp)
export VGREB_TMPFILE="$tmpfile"
yt-dlp --color never --no-progress \
    --download-archive "$prefix/archive.txt" \
    --rm-cache-dir \
    --exec 'after_move:echo '{}' > "$VGREB_TMPFILE"' \
    "$url" > "$log_file" 2>&1
rc=$?
downloaded_file="$(cat $tmpfile)"
rm -f -- $tmpfile

if [ $rc -eq 0 ]; then
    history_line SUCCESS "$downloaded_file" >> "$history"
    msg "Complete: $url"
else
    history_line FAIL "$downloaded_file" >> "$history"
    echo "Fail: $url (exit with $rc)."
    cat "$log_file" >&2
    action=$(notify-send "$self" "Fail: $rc. Click to see log" \
        --action="default=View Log")

    case "$action" in
        "default") foot -T "${self}-log" less "$log_file" ;;
    esac
fi

exit $rc
