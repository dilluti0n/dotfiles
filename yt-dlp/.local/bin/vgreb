#!/usr/bin/env bash

self=vgreb
prefix="$HOME/.$self"
history="$prefix/history"
log_dir="$prefix/logs"
download_id=$(uuidgen | tr -d '-' | head -c 8)

get_logfile() {
    echo "$log_dir/${1}.log"
}

log_file="$(get_logfile $download_id)"
format='%s\t%s\t%s\t%s\t%s\t%s\n'

mkdir -p "$prefix"
mkdir -p "$log_dir"

if [ ! -f "$history" ]; then
    printf "$format" download_id start_ts end_ts state url file > "$history"
fi

history_lock="${history}.lock"
touch "$history_lock"

histlock() {
    flock "$history_lock" "$@"
}

ts() {
    date -Iseconds
}

msg() {
    notify-send "$self" "$1"
    echo "$self: $1"
}

cmd_download() {
    url="$1"
    cmd=download

    if [ -t 0 ] && [ $# -eq 0 ]; then
        msg "$cmd: usage: $self download <url>"
        exit 1
    fi

    if [ -z "$url" ]; then
        msg "Error: no url provided" >&2
        exit 1
    fi

    if [[ "$url" =~ [[:space:]] ]]; then
        msg "Error: $url: Invalid URL (whitespace detected)" >&2
        exit 1
    fi

    start_ts=$(ts)
    na="N/A"
    histlock bash -c 'printf "$1" "$2" "$3" "$4" "$5" "$6" "$7" >> "$8"' -- \
             "$format" "$download_id" "$start_ts" "$na" "DOWNLOADING" "$url" "$na" "$history"

    msg "Download start: $url"

    tmpfile=$(mktemp)
    export VGREB_TMPFILE="$tmpfile"
    yt-dlp --color never --progress --newline \
           --download-archive "$prefix/archive.txt" \
           --rm-cache-dir \
           --exec 'after_move:echo "{}" > "$VGREB_TMPFILE"' \
           "$url" 2>&1 | tee "$log_file"
    rc=$?
    end_ts=$(ts)

    if [ -s "$tmpfile" ]; then
        dfile="$(cat "$tmpfile")"
    else
        dfile="$na"
    fi
    rm -f -- $tmpfile

    if [ $rc -eq 0 ]; then
        [ "$dfile" = "$na" ] && state="EXIST" || state="SUCCESS"
        msg "Complete: ${dfile##*/}"
    else
        state="FAIL($rc)"
        msg "Fail: $url (exit with $rc)."
    fi

    new_line="$(printf "$format" "$download_id" "$start_ts" "$end_ts" \
                       "$state" "$url" "$dfile")"
    histlock sed -i "s|^.*$download_id.*$|$new_line|" "$history"

    exit $rc
}

cmd_history() {
    column -t -s $'\t' "$history" | ${PAGER:-cat}
}

cmd_log() {
    local id="${1:-$(tail -n 1 "$history" | cut -f 1)}"
    ${PAGER:-cat} "$(get_logfile "$id")"
}

case "$1" in
    history)
        cmd_history
        ;;
    log)
        shift
        cmd_log "$@"
        ;;
    help)
        echo "Usage: $self [command]"
        echo ""
        echo "Commands:"
        echo "  download* <url> Download <url> via yt-dlp"
        echo "  history         Show history."
        echo "  log       [id]  Show log of [id]. If [id] is not given, show recent one."
        echo "  help            Show this help."
        exit 0
        ;;
    *)
        [ "$1" = "download" ] && shift
        cmd_download "$@"
        ;;
esac
